@page "/DeveloperPortal"
@using MudBlazor
@using OutsourcingSystemWepApp.Data.DTOs
@using OutsourcingSystemWepApp.Services
@inject IDeveloperServices DeveloperService
@inject IDeveloperSkillService DeveloperSkillService
@inject ISkillService SkillService
@inject AuthenticationStateProvider AuthenticationStateProvider



<MudContainer>
    <MudCard>
        <MudCardContent>
            <MudText Typo="Typo.h4">Developer Profile</MudText>

            <MudTextField Label="Name" @bind-Value="developer.Name" Disabled="true" />
            <MudTextField Label="Email" @bind-Value="developer.Email" Disabled="true" />
            <MudTextField Label="Specialization" @bind-Value="developer.Specialization" />
            <MudTextField Label="Years of Experience" @bind-Value="developer.YearsOfExperience" Type="number" />
            <MudTextField Label="Age" @bind-Value="developer.Age" Type="number" />
            <MudTextField Label="Hourly Rate" @bind-Value="developer.HourlyRate" Type="number" />
            <MudTextField Label="Career Summary" @bind-Value="developer.CareerSummary" Multiline="true" />
            <MudTextField Label="Current Project" @bind-Value="developer.CurrentProject" />
            <MudTextField Label="Completed Projects" @bind-Value="developer.CompletedProjects" Type="number" />



@* 

            <MudText Typo="Typo.h5">Download a File</MudText>

            <MudLink Href="@($"/api/files/{developer.DocumentLink}")" Target="_blank">Download CV</MudLink>

            <MudTextField Label="Enter File Name" @bind-Value="developer.DocumentLink" />
            <MudButton OnClick="DownloadFile">Download</MudButton>
 *@
           


            <label>Upload Your CV:</label>
            <InputFile OnChange="HandleFileSelected" />




            <MudButton OnClick="UpdateProfile" Color="Color.Primary">Update Profile</MudButton>


        </MudCardContent>
    </MudCard>
</MudContainer>

<MudContainer>
    <MudCard>
        <MudCardContent>

            
            <MudText Typo="Typo.h6">Manage Skills</MudText>
            <MudSelect @bind-Value="selectedSkill" Label="Select Skill">
                @foreach (var skill in skillsList)
                {
                    <MudSelectItem Value="@skill.SkillID">@skill.SkillName</MudSelectItem>
                }
            </MudSelect>
            
            <MudSlider @bind-Value="skillProficiency" Min="1" Max="10" Step="1" Label="Skill Proficiency" FullWidth="true" />
            <MudButton OnClick="AddDeveloperSkilll" Color="Color.Primary">Add Skill</MudButton>
            
            <MudList T="string">
                @foreach (var skill in developerSkills)
                {
                    <MudListItem>
                        @skill.SkillName - Level: @skill.Proficiency
                        <MudButton OnClick="() => RemoveSkillFromDeveloper(skill.SkillID)" Color="Color.Error">Remove</MudButton>
                    </MudListItem>
                }
            </MudList>
        </MudCardContent>
    </MudCard>
</MudContainer>



@code {
    private DeveloperDTOForProfile developer = new DeveloperDTOForProfile();
    private string UploadedFileName;





   // private DeveloperDTOForProfile devProfile = new DeveloperDTOForProfile();
    private List<SkillDTO> skillsList = new List<SkillDTO>();
    private List<DeveloperSkillDTO> developerSkills = new List<DeveloperSkillDTO>();
    private int selectedSkill;
    private int skillProficiency = 5;




    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        int developerId = int.Parse(user.FindFirst(c => c.Type == "DeveloperID")?.Value ?? "0");

        developer = await DeveloperService.GetDeveloperProfile(developerId);

        //new 
        var skills = SkillService.GetAllSkills();
        if (skills != null && skills.Any())
        {
            skillsList = skills
                .Select(s => new SkillDTO
                    {
                        SkillID = s.SkillID,
                        SkillName = s.Name
                    })
                .ToList();
        }
        else
        {
            Console.WriteLine("skill not found.");
        }

        developerSkills = DeveloperSkillService.GetDeveloperSkills(developer.DeveloperID)
            .Select(ds => new DeveloperSkillDTO
                {
                    DeveloperID = ds.DeveloperID,
                    SkillID = ds.SkillID,
                    SkillName = skillsList.FirstOrDefault(s => s.SkillID == ds.SkillID)?.SkillName ?? "Unknown",
                    Proficiency = ds.Proficiency
                })
            .ToList();



    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null && file.ContentType == "application/pdf")
        {
            UploadedFileName = file.Name;

            using var stream = file.OpenReadStream(10 * 1024 * 1024); 
            await SaveFileToDisk(stream, file.Name);


            developer.DocumentLink = $"/DeveloperCVs/{file.Name}";
            await UpdateProfile();
        }
        else
        {
            UploadedFileName = "Invalid file. Please upload a PDF.";
        }
    }


    private async Task SaveFileToDisk(Stream fileStream, string fileName)
    {
        var savePath = Path.Combine("wwwroot", "DeveloperCVs", fileName);

        using var file = File.Create(savePath);
        fileStream.Seek(0, SeekOrigin.Begin);
        await fileStream.CopyToAsync(file);
    }

    private async Task UpdateProfile()
    {
        await DeveloperService.UpdateDeveloperProfile(developer);
    }
    private string[] GetAvailableSkills()
    {
        List<string> SkillNames = new List<string>();
        var Skills = SkillService.GetAllSkills(0, int.MaxValue, true, null);
        foreach (var skill in Skills)
        {
            SkillNames.Add(skill.Name);
        }
        return SkillNames.ToArray();
    }

    private int[] GetRatings()
    {
        int[] Ratings = { 1, 2, 3, 4, 5 };
        return Ratings;
    }


   

    private void AddDeveloperSkilll()
    {
        if (selectedSkill > 0)
        {
           
            DeveloperSkillService.AddDeveloperSkilll( selectedSkill,developer.DeveloperID, skillProficiency);

          
            developerSkills = DeveloperSkillService.GetDeveloperSkills(developer.DeveloperID)
                .Select(ds => new DeveloperSkillDTO
                    {
                        DeveloperID = ds.DeveloperID,
                        SkillID = ds.SkillID,
                        SkillName = skillsList.FirstOrDefault(s => s.SkillID == ds.SkillID)?.SkillName ?? "Unknown",
                        Proficiency = ds.Proficiency
                    })
                .ToList();
        }
    }



    private void RemoveSkillFromDeveloper(int skillId)
    {
        DeveloperSkillService.RemoveDeveloperSkill(developer.DeveloperID, skillId);
        developerSkills = DeveloperSkillService.GetDeveloperSkills(developer.DeveloperID)
        .Select(ds => new DeveloperSkillDTO
        {
            DeveloperID = ds.DeveloperID,
            SkillID = ds.SkillID,
            SkillName = skillsList.FirstOrDefault(s => s.SkillID == ds.SkillID)?.SkillName ?? "Unknown",
            Proficiency = ds.Proficiency
        })
       .ToList();
    }

    private string FileName = "test.pdf"; // Example file
    private string FileUrl;

    private void DownloadFile()
    {
        FileUrl = $"/api/files/{developer.DocumentLink}";
    }

}

